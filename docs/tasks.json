{
  "agent_instructions": {
    "before_start": [
      "Прочитай этот файл и git log --oneline -20",
      "Выбери ОДНУ задачу со статусом pending и наивысшим приоритетом",
      "Проверь, что все dependencies этой задачи имеют статус done"
    ],
    "during_work": [
      "Работай только над выбранной задачей",
      "Делай коммиты после каждого логического изменения",
      "Не трогай код, не связанный с текущей задачей"
    ],
    "before_finish": [
      "Выполни ВСЕ test_steps из задачи",
      "Меняй status на done ТОЛЬКО после успешного прохождения всех тестов",
      "Напиши summary в progress.md",
      "ЗАПРЕЩЕНО удалять или редактировать задачи — только менять status"
    ]
  },
  "tasks": [
    {
      "id": "TASK-001",
      "category": "infrastructure",
      "priority": "critical",
      "description": "Подготовить переменные окружения и секреты для MVP (OpenRouter, OCR, БД, Redis, auth) с валидацией схемы.",
      "acceptance_criteria": [
        "Все обязательные переменные описаны в схеме env и в .env.example",
        "Приложения frontend/backend стартуют без ошибок конфигурации",
        "При отсутствии обязательного секрета сервис падает с понятной ошибкой"
      ],
      "test_steps": [
        "Шаг 1: Заполнить .env тестовыми значениями и запустить bun run dev",
        "Шаг 2: Удалить один обязательный секрет и перезапустить backend",
        "Шаг 3: Убедиться, что выводится явная ошибка о недостающей переменной"
      ],
      "dependencies": [],
      "status": "done"
    },
    {
      "id": "TASK-002",
      "category": "infrastructure",
      "priority": "critical",
      "description": "Подключить базовую наблюдаемость: Sentry SDK в frontend и backend с окружениями и release тегами.",
      "acceptance_criteria": [
        "Ошибки backend отправляются в Sentry",
        "Ошибки frontend отправляются в Sentry",
        "События содержат environment и release"
      ],
      "test_steps": [
        "Шаг 1: Искусственно сгенерировать ошибку в backend dev-эндпоинте",
        "Шаг 2: Искусственно сгенерировать ошибку на frontend странице",
        "Шаг 3: Проверить, что оба события появились в Sentry с корректными тегами"
      ],
      "dependencies": ["TASK-001"],
      "status": "pending"
    },
    {
      "id": "TASK-003",
      "category": "infrastructure",
      "priority": "critical",
      "description": "Добавить метрики latency/queue/error и базовые Grafana-дашборды для ключевых MVP-потоков.",
      "acceptance_criteria": [
        "Экспортируются метрики p95 времени ответа fast-mode",
        "Экспортируются метрики очередей OCR/RAG и ошибок генерации",
        "Есть минимум один дашборд с KPI MVP"
      ],
      "test_steps": [
        "Шаг 1: Выполнить серию запросов в чат и в OCR пайплайн",
        "Шаг 2: Открыть Grafana и найти обновившиеся метрики",
        "Шаг 3: Убедиться, что на дашборде видны latency, queue depth и error rate"
      ],
      "dependencies": ["TASK-001"],
      "status": "pending"
    },
    {
      "id": "TASK-004",
      "category": "infrastructure",
      "priority": "high",
      "description": "Реализовать абстракцию OCR-провайдера с возможностью подключать fallback цепочку.",
      "acceptance_criteria": [
        "Есть единый интерфейс OCRService",
        "Поддерживается минимум один основной и один резервный адаптер",
        "Переключение на fallback происходит по ошибке/таймауту"
      ],
      "test_steps": [
        "Шаг 1: Вызвать OCR через основной провайдер на валидном изображении",
        "Шаг 2: Смоделировать падение основного провайдера",
        "Шаг 3: Проверить успешное выполнение через fallback и лог события"
      ],
      "dependencies": ["TASK-001"],
      "status": "pending"
    },
    {
      "id": "TASK-005",
      "category": "functional",
      "priority": "critical",
      "description": "Добавить модели и миграции для StudentProfile, TemplatePreset, UploadedDocument, DocumentChunk, SafetyEvent.",
      "acceptance_criteria": [
        "Все сущности из PRD присутствуют в схеме БД",
        "Миграции применяются и откатываются штатно",
        "Индексы и связи user_id/document_id созданы"
      ],
      "test_steps": [
        "Шаг 1: Сгенерировать миграцию через CLI и выполнить migrations:up",
        "Шаг 2: Проверить таблицы и индексы в БД",
        "Шаг 3: Выполнить migrations:down и убедиться в корректном rollback"
      ],
      "dependencies": ["TASK-001"],
      "status": "done"
    },
    {
      "id": "TASK-006",
      "category": "functional",
      "priority": "critical",
      "description": "Реализовать backend домен ChatSession/Message для режимов fast/learning с сохранением истории.",
      "acceptance_criteria": [
        "Можно создать сессию и отправить сообщение пользователя",
        "Ответ ассистента сохраняется в message",
        "Список сообщений возвращается в правильном порядке"
      ],
      "test_steps": [
        "Шаг 1: Создать чат-сессию через API",
        "Шаг 2: Отправить сообщение и получить ответ",
        "Шаг 3: Запросить историю и проверить роли/порядок сообщений"
      ],
      "dependencies": ["TASK-005"],
      "status": "done"
    },
    {
      "id": "TASK-007",
      "category": "integration",
      "priority": "critical",
      "description": "Собрать end-to-end пайплайн загрузки изображения: upload -> OCR -> OpenRouter -> ответ в чат.",
      "acceptance_criteria": [
        "Скриншот загружается и проходит OCR",
        "OCR текст передается в AI-генерацию через OpenRouter",
        "Пользователь получает полный ответ в одном чат-ходе"
      ],
      "test_steps": [
        "Шаг 1: Загрузить изображение задачи в чат",
        "Шаг 2: Отправить команду 'реши'",
        "Шаг 3: Проверить, что пришел полный ответ и сохранен в истории"
      ],
      "dependencies": ["TASK-004", "TASK-006"],
      "status": "pending"
    },
    {
      "id": "TASK-008",
      "category": "functional",
      "priority": "high",
      "description": "Добавить обработку низкой уверенности OCR: fallback-сообщение и предложение ввести текст вручную.",
      "acceptance_criteria": [
        "При confidence ниже порога возвращается понятный fallback",
        "Fallback не ломает чат-сессию",
        "В логи пишется причина fallback"
      ],
      "test_steps": [
        "Шаг 1: Передать размытое изображение или смоделировать низкий confidence",
        "Шаг 2: Получить fallback-подсказку вместо некорректного решения",
        "Шаг 3: Ввести текст задачи вручную и получить обычный ответ"
      ],
      "dependencies": ["TASK-007"],
      "status": "pending"
    },
    {
      "id": "TASK-009",
      "category": "functional",
      "priority": "critical",
      "description": "Реализовать CRUD API для TemplatePreset и хранение default-шаблона пользователя.",
      "acceptance_criteria": [
        "Работают create/read/update/delete шаблона",
        "Можно назначить ровно один шаблон default",
        "Шаблоны сохраняются между сессиями"
      ],
      "test_steps": [
        "Шаг 1: Создать два шаблона через API",
        "Шаг 2: Назначить один default и убедиться, что второй снят",
        "Шаг 3: Перелогиниться и проверить сохранение настроек"
      ],
      "dependencies": ["TASK-005"],
      "status": "done"
    },
    {
      "id": "TASK-010",
      "category": "integration",
      "priority": "critical",
      "description": "Интегрировать template injection в prompt pipeline fast/learning режимов.",
      "acceptance_criteria": [
        "Активный шаблон влияет на тон, формат, длину и язык ответа",
        "Default-шаблон применяется автоматически в новых чатах",
        "Без шаблона используется безопасный системный профиль"
      ],
      "test_steps": [
        "Шаг 1: Создать шаблон с дружественным тоном и коротким форматом",
        "Шаг 2: Запустить новый чат и запросить решение",
        "Шаг 3: Проверить, что стиль ответа соответствует шаблону"
      ],
      "dependencies": ["TASK-007", "TASK-009"],
      "status": "pending"
    },
    {
      "id": "TASK-011",
      "category": "functional",
      "priority": "high",
      "description": "Добавить endpoint/режим для пошагового объяснения на основе уже полученного финального ответа.",
      "acceptance_criteria": [
        "Для каждого assistant-ответа можно запросить step-by-step",
        "Пояснение учитывает уровень из профиля/шаблона",
        "Сложная нотация не используется без явного запроса"
      ],
      "test_steps": [
        "Шаг 1: Получить финальный ответ в fast-mode",
        "Шаг 2: Запросить пошаговое объяснение",
        "Шаг 3: Проверить, что шаги понятны уровню ученика и сохранены в истории"
      ],
      "dependencies": ["TASK-010"],
      "status": "pending"
    },
    {
      "id": "TASK-012",
      "category": "functional",
      "priority": "high",
      "description": "Реализовать загрузку пользовательских учебных файлов и хранение метаданных UploadedDocument.",
      "acceptance_criteria": [
        "Поддерживаются выбранные форматы MVP",
        "Файл сохраняется в хранилище, метаданные пишутся в БД",
        "Статус документа корректно обновляется (uploaded/processed/failed)"
      ],
      "test_steps": [
        "Шаг 1: Загрузить валидный файл учебника",
        "Шаг 2: Проверить запись в UploadedDocument",
        "Шаг 3: Загрузить неподдерживаемый формат и проверить ожидаемую ошибку"
      ],
      "dependencies": ["TASK-005"],
      "status": "pending"
    },
    {
      "id": "TASK-013",
      "category": "integration",
      "priority": "high",
      "description": "Построить очередь индексации документов (BullMQ): парсинг, чанкинг, создание DocumentChunk.",
      "acceptance_criteria": [
        "После upload запускается асинхронный job индексации",
        "Текст разбивается на чанки и сохраняется в DocumentChunk",
        "Ошибки индексации меняют статус документа на failed"
      ],
      "test_steps": [
        "Шаг 1: Загрузить документ и дождаться обработки очереди",
        "Шаг 2: Проверить созданные чанки в БД",
        "Шаг 3: Смоделировать ошибку парсинга и проверить статус failed"
      ],
      "dependencies": ["TASK-012"],
      "status": "pending"
    },
    {
      "id": "TASK-014",
      "category": "functional",
      "priority": "high",
      "description": "Реализовать retrieval API по пользовательскому корпусу с выдачей релевантных фрагментов и page_ref.",
      "acceptance_criteria": [
        "По запросу возвращаются топ-N релевантных чанков",
        "В выдаче присутствуют ссылки/указатели на источник",
        "Поиск ограничен документами текущего пользователя"
      ],
      "test_steps": [
        "Шаг 1: Проиндексировать документ с известным содержимым",
        "Шаг 2: Выполнить поисковый запрос по ключевой теме",
        "Шаг 3: Проверить релевантность и наличие source refs"
      ],
      "dependencies": ["TASK-013"],
      "status": "pending"
    },
    {
      "id": "TASK-015",
      "category": "integration",
      "priority": "high",
      "description": "Добавить RAG-режим генерации ответа с обязательным цитированием источников из retrieval.",
      "acceptance_criteria": [
        "Ответ по документам включает цитируемые фрагменты",
        "При низкой релевантности срабатывает fallback с предупреждением",
        "RAG-ответ сохраняется как обычное сообщение в сессии"
      ],
      "test_steps": [
        "Шаг 1: Задать вопрос по загруженному документу",
        "Шаг 2: Получить ответ с явными ссылками на источники",
        "Шаг 3: Задать вопрос вне корпуса и проверить fallback-предупреждение"
      ],
      "dependencies": ["TASK-014", "TASK-006"],
      "status": "pending"
    },
    {
      "id": "TASK-016",
      "category": "security",
      "priority": "critical",
      "description": "Реализовать MVP-аутентификацию (Google OAuth + magic link) и защищенные сессии.",
      "acceptance_criteria": [
        "Вход через Google OAuth работает",
        "Вход через magic link работает",
        "Защищенные эндпоинты недоступны без валидной сессии"
      ],
      "test_steps": [
        "Шаг 1: Выполнить логин через Google",
        "Шаг 2: Выполнить логин через magic link",
        "Шаг 3: Запросить приватный API без сессии и получить 401"
      ],
      "dependencies": ["TASK-001"],
      "status": "pending"
    },
    {
      "id": "TASK-017",
      "category": "security",
      "priority": "critical",
      "description": "Обеспечить строгую изоляцию данных пользователя для чатов, шаблонов и документов на уровне репозиториев/API.",
      "acceptance_criteria": [
        "Ни один пользователь не может читать чужие документы и чаты",
        "Все user-scoped запросы фильтруются по user_id",
        "Нарушения доступа логируются как security события"
      ],
      "test_steps": [
        "Шаг 1: Создать данные для двух разных пользователей",
        "Шаг 2: Попробовать запросить чужой ресурс по id",
        "Шаг 3: Убедиться, что возвращается 403/404 и нет утечки данных"
      ],
      "dependencies": ["TASK-016", "TASK-005"],
      "status": "pending"
    },
    {
      "id": "TASK-018",
      "category": "security",
      "priority": "critical",
      "description": "Добавить moderation/guardrail пайплайн для unsafe-запросов и unsafe-ответов с логированием SafetyEvent.",
      "acceptance_criteria": [
        "Опасные запросы блокируются или санитизируются",
        "Шаблоны пользователя не могут отключить safety-политику",
        "SafetyEvent сохраняется с типом и severity"
      ],
      "test_steps": [
        "Шаг 1: Отправить заведомо небезопасный запрос",
        "Шаг 2: Проверить, что пользователь получает безопасный ответ/блок",
        "Шаг 3: Проверить запись в таблице SafetyEvent"
      ],
      "dependencies": ["TASK-005", "TASK-007"],
      "status": "pending"
    },
    {
      "id": "TASK-019",
      "category": "security",
      "priority": "high",
      "description": "Реализовать удаление данных пользователя: чаты, документы, индексы и связанные артефакты.",
      "acceptance_criteria": [
        "Есть API удаления документа с каскадным удалением чанков",
        "Есть API удаления/архивации чатов по политике retention",
        "Удаленные данные не возвращаются в API и поиск"
      ],
      "test_steps": [
        "Шаг 1: Создать чат и загрузить документ",
        "Шаг 2: Выполнить удаление через API",
        "Шаг 3: Проверить, что поиск/история больше не содержат удаленные данные"
      ],
      "dependencies": ["TASK-015", "TASK-017"],
      "status": "pending"
    },
    {
      "id": "TASK-020",
      "category": "ui",
      "priority": "critical",
      "description": "Собрать экран первого использования: поле ввода, загрузка изображения, CTA «Решить задачу».",
      "acceptance_criteria": [
        "Пользователь видит один главный сценарий: загрузить или вставить задачу",
        "Отправка запускает fast-mode и показывает состояние загрузки",
        "Время до первого полезного результата визуально укладывается в 1-2 минуты"
      ],
      "test_steps": [
        "Шаг 1: Открыть приложение новым пользователем",
        "Шаг 2: Загрузить скриншот и отправить запрос",
        "Шаг 3: Проверить корректный рендер ответа и состояний loading/error"
      ],
      "dependencies": ["TASK-007"],
      "status": "pending"
    },
    {
      "id": "TASK-021",
      "category": "ui",
      "priority": "high",
      "description": "Добавить UX для OCR fallback: понятный текст ошибки, советы по качеству фото и ручной ввод.",
      "acceptance_criteria": [
        "При OCR fallback показывается отдельный информативный блок",
        "Есть CTA для ручного ввода задачи",
        "Пользователь может продолжить сценарий без перезагрузки"
      ],
      "test_steps": [
        "Шаг 1: Спровоцировать OCR fallback на UI",
        "Шаг 2: Проверить наличие советов и CTA ручного ввода",
        "Шаг 3: Ввести задачу вручную и получить решение"
      ],
      "dependencies": ["TASK-008", "TASK-020"],
      "status": "pending"
    },
    {
      "id": "TASK-022",
      "category": "ui",
      "priority": "high",
      "description": "Сделать UI управления шаблонами ответов: список, создание, редактирование, удаление, установка default.",
      "acceptance_criteria": [
        "Пользователь может полностью управлять жизненным циклом шаблона",
        "Активный default явно отмечен в интерфейсе",
        "Изменения сохраняются и отражаются после перезагрузки"
      ],
      "test_steps": [
        "Шаг 1: Создать и отредактировать шаблон через UI",
        "Шаг 2: Назначить шаблон default и удалить лишний",
        "Шаг 3: Перезагрузить страницу и проверить сохраненное состояние"
      ],
      "dependencies": ["TASK-009"],
      "status": "pending"
    },
    {
      "id": "TASK-023",
      "category": "ui",
      "priority": "high",
      "description": "Показать активный шаблон в чате и дать one-click переключение/редактирование.",
      "acceptance_criteria": [
        "В чате отображается текущий активный шаблон",
        "Переключение шаблона доступно в один клик",
        "Новый шаблон применяется к следующему сообщению"
      ],
      "test_steps": [
        "Шаг 1: Открыть чат с несколькими шаблонами",
        "Шаг 2: Переключить активный шаблон в один клик",
        "Шаг 3: Отправить новый запрос и проверить изменение стиля ответа"
      ],
      "dependencies": ["TASK-022", "TASK-010"],
      "status": "pending"
    },
    {
      "id": "TASK-024",
      "category": "ui",
      "priority": "high",
      "description": "Добавить UI-триггер «Показать пошаговое объяснение» для каждого финального ответа.",
      "acceptance_criteria": [
        "После получения ответа доступна кнопка/действие 'Показать шаги'",
        "Пошаговый ответ визуально отделен от финального",
        "Пользователь может вернуться к краткому виду"
      ],
      "test_steps": [
        "Шаг 1: Получить финальный ответ в чате",
        "Шаг 2: Нажать 'Показать шаги'",
        "Шаг 3: Проверить рендер шагов и переключение между режимами"
      ],
      "dependencies": ["TASK-011", "TASK-020"],
      "status": "pending"
    },
    {
      "id": "TASK-025",
      "category": "ui",
      "priority": "medium",
      "description": "Собрать UI загрузки и управления учебными материалами (список файлов, статусы, удаление).",
      "acceptance_criteria": [
        "Пользователь может загрузить файл из интерфейса",
        "Статус uploaded/processed/failed отображается в списке",
        "Удаление файла доступно и обновляет список без перезагрузки"
      ],
      "test_steps": [
        "Шаг 1: Загрузить документ через UI",
        "Шаг 2: Дождаться завершения индексации и проверить статус",
        "Шаг 3: Удалить документ и убедиться, что он исчез из списка"
      ],
      "dependencies": ["TASK-013"],
      "status": "pending"
    },
    {
      "id": "TASK-026",
      "category": "ui",
      "priority": "medium",
      "description": "Добавить визуализацию источников в RAG-ответах (сниппеты, page_ref, переход к документу).",
      "acceptance_criteria": [
        "Каждый RAG-ответ показывает блок источников",
        "У источника есть читаемый сниппет и page_ref",
        "При отсутствии источника показывается прозрачное предупреждение"
      ],
      "test_steps": [
        "Шаг 1: Получить ответ по загруженному документу",
        "Шаг 2: Проверить отображение списка источников",
        "Шаг 3: Проверить предупреждение на вопросе вне корпуса"
      ],
      "dependencies": ["TASK-015", "TASK-025"],
      "status": "pending"
    },
    {
      "id": "TASK-027",
      "category": "integration",
      "priority": "high",
      "description": "Реализовать streaming-ответы в чате для снижения perceived latency в fast-mode.",
      "acceptance_criteria": [
        "Ответ ассистента приходит частями (token stream)",
        "Клиент корректно рендерит поток и финализирует сообщение",
        "При ошибке потока отображается понятный retry"
      ],
      "test_steps": [
        "Шаг 1: Отправить типичный fast-mode запрос",
        "Шаг 2: Проверить, что UI показывает поступление текста в реальном времени",
        "Шаг 3: Прервать поток и проверить корректный обработчик ошибки"
      ],
      "dependencies": ["TASK-007", "TASK-020"],
      "status": "pending"
    },
    {
      "id": "TASK-028",
      "category": "infrastructure",
      "priority": "high",
      "description": "Ввести лимиты токенов/квот, троттлинг очередей и бюджетные guardrails для ограничения затрат MVP.",
      "acceptance_criteria": [
        "Лимиты токенов применяются по режимам fast/learning",
        "Очереди имеют ограничение конкурентности и rate limit",
        "При превышении лимита пользователь получает корректное сообщение"
      ],
      "test_steps": [
        "Шаг 1: Отправить запросы с большим контекстом и проверить срабатывание лимитов",
        "Шаг 2: Сгенерировать нагрузку в очереди и проверить троттлинг",
        "Шаг 3: Убедиться в корректных user-facing ошибках при превышении квоты"
      ],
      "dependencies": ["TASK-007", "TASK-013"],
      "status": "pending"
    },
    {
      "id": "TASK-029",
      "category": "integration",
      "priority": "high",
      "description": "Покрыть критический пользовательский путь e2e: логин -> загрузка задачи -> решение -> шаги -> шаблон.",
      "acceptance_criteria": [
        "E2E тест проходит стабильно в CI локально",
        "Сценарий покрывает минимум один OCR fallback кейс",
        "Сценарий проверяет применение default шаблона"
      ],
      "test_steps": [
        "Шаг 1: Запустить полный e2e набор с новым тестом",
        "Шаг 2: Проверить прохождение happy-path и fallback-path",
        "Шаг 3: Проверить артефакты Playwright при падении"
      ],
      "dependencies": ["TASK-016", "TASK-021", "TASK-024"],
      "status": "pending"
    },
    {
      "id": "TASK-030",
      "category": "infrastructure",
      "priority": "medium",
      "description": "Подготовить операционный runbook launch-readiness: алерты, инциденты, чеклист деплоя и восстановления.",
      "acceptance_criteria": [
        "В docs есть runbook с шагами реагирования на 5xx/латентность/очереди",
        "Определены базовые алерты и контакты эскалации",
        "Есть чеклист pre-release и rollback"
      ],
      "test_steps": [
        "Шаг 1: Провести tabletop-симуляцию инцидента 5xx",
        "Шаг 2: Пройти чеклист восстановления",
        "Шаг 3: Обновить runbook по итогам симуляции"
      ],
      "dependencies": ["TASK-002", "TASK-003", "TASK-028"],
      "status": "pending"
    }
  ]
}
